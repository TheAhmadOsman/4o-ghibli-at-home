<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Photo Stylizer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">

    <!-- The custom CSS provided in the prompt is placed here -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');

        :root {
            --ff: "Ubuntu", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --radius: 6px;

            --primary-color: #012a36;
            --secondary-color: #fcffeb;
            --secondary-color-dark: #d5b986;
            --tertiary-color: #c85c2d;
            --tertiary-color-light: #d26637;
            --link-color: #b7542a;

            --black: #292929;
            --code-bg: #272822;
            --code-fg: #f8f8f2;
            --code-scroll-thumb: #525252;
            --scrollbar-track: #efefe6;
            --scrollbar-thumb: #b7b78f;
        }

        /* Simplified dark mode for this app */
        body.dark {
            --primary-color: #efefe6;
            --secondary-color: #292929;
            --tertiary-color: #ff7f11;
            --link-color: #c76c1c;
            --tertiary-color-light: #a34c00;
            --secondary-color-dark: #343431;
            --scrollbar-track: #292929;
            --scrollbar-thumb: #525252;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--ff);
            background: var(--secondary-color);
            min-height: 100vh;
            color: var(--primary-color);
            padding: 20px;
            transition: all 0.3s ease;
            display: block;
            /* Override flex for a more traditional layout */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: var(--radius);
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (min-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr 400px;
                /* Main content and a sidebar */
            }
        }

        .main-content,
        .controls-panel {
            background: var(--secondary-color);
            border: 2px solid var(--secondary-color-dark);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--tertiary-color);
            text-align: center;
        }

        h2 {
            font-size: 1.5em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* --- Image Upload & Preview --- */
        #upload-area {
            border: 3px dashed var(--secondary-color-dark);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            /* Updated: parent container handles spacing */
            flex-grow: 1;
            /* New: allows it to grow in flex container */
        }

        /* NEW: Disabled state for the upload area */
        #upload-area.disabled {
            cursor: not-allowed;
            opacity: 0.6;
            border-style: solid;
        }

        #upload-area.drag-over {
            border-color: var(--tertiary-color);
            background-color: var(--secondary-color-dark);
        }

        #upload-area p {
            font-size: 1.2em;
            color: var(--primary-color);
            opacity: 0.7;
        }

        #file-input {
            display: none;
        }

        #image-preview-wrapper {
            position: relative;
            width: 100%;
            background: var(--code-bg);
            border-radius: var(--radius);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #image-preview {
            max-width: 100%;
            max-height: 80vh;
            display: none;
            /* Hidden until an image is loaded */
        }

        /* NEW: Container for bottom upload controls */
        .upload-controls {
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .cancel-upload-btn {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        /* --- General UI Elements --- */
        .btn {
            padding: 12px 25px;
            background: var(--tertiary-color);
            border: none;
            border-radius: var(--radius);
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-family: var(--ff);
            font-weight: 500;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: var(--tertiary-color-light);
        }

        .btn:disabled {
            background: var(--secondary-color-dark);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--primary-color);
            border: 2px solid var(--secondary-color-dark);
        }

        .btn-secondary:hover {
            border-color: var(--tertiary-color);
        }

        .btn-secondary:disabled {
            background: var(--secondary-color);
            border-color: var(--secondary-color-dark);
            color: var(--primary-color);
            opacity: 0.5;
        }

        /* --- Controls Panel --- */
        /* NEW: Consistent Section Separator */
        .settings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--secondary-color-dark);
        }

        .control-group {
            margin-bottom: 20px;
        }

        /* Make the last group in a section have no bottom margin for cleaner spacing */
        .settings-section>.control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label,
        .optional-control .label-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .control-group input[type="range"],
        .control-group input[type="number"],
        .control-group input[type="text"],
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 10px;
            background: var(--secondary-color);
            border: 2px solid var(--secondary-color-dark);
            border-radius: var(--radius);
            color: var(--primary-color);
            font-size: 16px;
            font-family: var(--ff);
            outline: none;
            transition: all 0.3s ease;
        }

        .control-group textarea:disabled,
        .control-group input:disabled {
            background-color: var(--secondary-color-dark);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .control-group input:focus,
        .control-group textarea:focus,
        .control-group select:focus {
            border-color: var(--tertiary-color);
        }

        .control-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input[type="number"] {
            width: 80px;
        }

        .profile-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .profile-btn {
            padding: 10px;
            background: var(--secondary-color);
            border: 2px solid var(--secondary-color-dark);
            border-radius: var(--radius);
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-family: var(--ff);
            text-align: center;
        }

        .profile-btn:hover {
            border-color: var(--tertiary-color-light);
        }

        .profile-btn.active {
            background: var(--tertiary-color);
            color: var(--secondary-color);
            border-color: var(--tertiary-color);
        }

        .optional-control .label-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .optional-control .label-wrapper label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .optional-control input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--tertiary-color);
        }

        .resolution-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resolution-inputs input {
            text-align: center;
        }

        .resolution-inputs span {
            font-weight: bold;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        /* Spacing for action buttons at the top of the panel */
        .controls-panel>.action-buttons {
            margin-top: 15px;
        }

        /* Styles for clickable section headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
            user-select: none;
            /* Prevent text selection on click */
        }

        /* Make clickable section headers look different from static H2s */
        .section-header:hover h2 {
            color: var(--tertiary-color);
        }

        .section-header h2 {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        #advanced-settings-header {
            margin-top: 20px;
            /* Space between prompt and this header */
        }

        .header-arrow {
            font-size: 1.425em;
            font-weight: bold;
            color: var(--tertiary-color);
            transition: transform 0.3s ease;
            line-height: 1;
        }

        .section-header[aria-expanded="true"] .header-arrow {
            transform: rotate(180deg);
        }

        #advanced-settings-content {
            display: none;
            /* Collapsed by default */
            padding-top: 15px;
        }

        /* --- Style Profiles Accordion --- */
        .profile-category {
            border-bottom: 1px solid var(--secondary-color-dark);
        }

        .profile-category:last-of-type {
            margin-bottom: 0;
        }

        .profile-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 12px 0;
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--primary-color);
            border: none;
            transition: color 0.3s ease;
        }

        .profile-category-header:hover {
            color: var(--tertiary-color);
        }

        .profile-category-header .header-arrow {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--tertiary-color);
            transition: transform 0.3s ease;
            line-height: 1;
        }

        .profile-category.active .profile-category-header .header-arrow {
            transform: rotate(180deg);
        }

        .profile-category.active .profile-category-header {
            color: var(--tertiary-color);
        }

        .profile-category-content {
            display: none;
            /* Hidden by default */
            padding-top: 10px;
            padding-bottom: 20px;
        }

        .profile-category.active .profile-category-content {
            display: grid;
        }

        /* NEW: Better layout for Custom Profile actions */
        .profile-action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .profile-action-group select,
        .profile-action-group input[type="text"] {
            flex-grow: 1;
            /* Allow input/select to fill space */
        }

        .profile-action-group .btn {
            padding: 10px 15px;
            /* Make buttons less wide */
            flex-shrink: 0;
            /* Prevent button from shrinking */
        }

        /* --- Loading and Error States --- */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            z-index: 10;
            border-radius: var(--radius);
        }

        #loader p {
            font-size: 1.2em;
            padding: 0 10px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--tertiary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tertiary-color);
            color: var(--secondary-color);
            padding: 15px 30px;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Main Content Area: Upload and Preview -->
        <main class="main-content">
            <h1>AI Photo Stylizer</h1>

            <div class="upload-controls">
                <div id="upload-area">
                    <input type="file" id="file-input" accept="image/png, image/jpeg, image/webp">
                    <p>Drag & Drop an Image Here or Click to Upload</p>
                </div>
                <button id="cancel-upload-btn" class="btn btn-secondary" style="display: none;">Cancel</button>
            </div>

            <div id="image-preview-wrapper">
                <img id="image-preview" alt="User-uploaded image preview">
                <div id="loader">
                    <div class="spinner"></div>
                    <p>Stylizing your image... <br> This can take a moment.</p>
                </div>
            </div>
        </main>

        <!-- Controls Panel -->
        <aside class="controls-panel">
            <h2>Controls</h2>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="apply-btn" class="btn" disabled>Apply Style</button>
                <button id="download-btn" class="btn btn-secondary" disabled>Download</button>
            </div>
            <div class="action-buttons">
                <button id="undo-btn" class="btn btn-secondary" disabled>Undo</button>
                <button id="redo-btn" class="btn btn-secondary" disabled>Redo</button>
            </div>

            <!-- Style Profiles -->
            <div class="settings-section style-profiles-section">
                <h2>Style Profiles</h2>
                <div id="style-profiles-accordion">

                    <!-- Category 1: Animation & Style Transfer (Expanded by default) -->
                    <div class="profile-category active">
                        <h3 class="profile-category-header" role="button" aria-expanded="true"
                            aria-controls="category-content-1" tabindex="0">
                            <span>Animation & Style Transfer</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-1" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="ghibli_style_1">Ghibli Soft</button>
                            <button class="profile-btn" data-profile="ghibli_style_2">Ghibli Classic</button>
                            <button class="profile-btn" data-profile="ghibli_inspired">Ghibli Inspired</button>
                            <button class="profile-btn" data-profile="ukiyo_e">Ukiyo-e</button>
                            <button class="profile-btn" data-profile="comic_book">Comic Book</button>
                        </div>
                    </div>

                    <!-- Category 2: Fancy & Dramatic Edits -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-2" tabindex="0">
                            <span>Fancy & Dramatic Edits</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-2" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="cyberpunk_style_1">Cyberpunk Neon</button>
                            <button class="profile-btn" data-profile="cyberpunk_style_2">Cyberpunk Retro</button>
                            <button class="profile-btn" data-profile="synthwave">Synthwave</button>
                            <button class="profile-btn" data-profile="brutalist">Brutalist</button>
                            <button class="profile-btn" data-profile="futurist_neon">Futurist Neon</button>
                            <button class="profile-btn" data-profile="fantasy">Fantasy Magic</button>
                        </div>
                    </div>

                    <!-- Category 3: Artistic & Creative -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-3" tabindex="0">
                            <span>Artistic & Creative</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-3" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="artistic_style_1">Expressive</button>
                            <button class="profile-btn" data-profile="artistic_style_2">Surreal</button>
                            <button class="profile-btn" data-profile="oil_painting">Oil Painting</button>
                            <button class="profile-btn" data-profile="watercolor">Watercolor</button>
                            <button class="profile-btn" data-profile="watercolor_dreamscape">Dreamscape</button>
                            <button class="profile-btn" data-profile="impressionist">Impressionist</button>
                            <button class="profile-btn" data-profile="renaissance">Classic Renaissance</button>
                            <button class="profile-btn" data-profile="painterly_renaissance">Painterly
                                Renaissance</button>
                            <button class="profile-btn" data-profile="pop_art">Pop Art</button>
                            <button class="profile-btn" data-profile="double_exposure">Double Exposure</button>
                        </div>
                    </div>

                    <!-- Category 4: Mood & Vintage -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-8" tabindex="0">
                            <span>Mood & Vintage</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-8" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="vintage">Vintage</button>
                            <button class="profile-btn" data-profile="art_deco">Art Deco</button>
                            <button class="profile-btn" data-profile="noir_detective">Noir Detective</button>
                            <button class="profile-btn" data-profile="steampunk">Steampunk</button>
                            <button class="profile-btn" data-profile="retro_film_grain">Retro Film Grain</button>
                            <button class="profile-btn" data-profile="classic_black_and_white">Classic B&W</button>
                            <button class="profile-btn" data-profile="monochrome">Monochrome</button>
                        </div>
                    </div>

                    <!-- Category 5: Landscape & Scenery -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-6" tabindex="0">
                            <span>Landscape & Scenery</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-6" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="landscape">Landscape</button>
                            <button class="profile-btn" data-profile="golden_hour_glow">Golden Hour</button>
                            <button class="profile-btn" data-profile="moody_cinematic">Moody Cinematic</button>
                            <button class="profile-btn" data-profile="night_cityscape">Night Cityscape</button>
                            <button class="profile-btn" data-profile="tilt_shift">Tilt Shift</button>
                            <button class="profile-btn" data-profile="infrared">Infrared</button>
                        </div>
                    </div>

                    <!-- Category 6: Portrait & People -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-5" tabindex="0">
                            <span>Portrait & People</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-5" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="portrait">Portrait</button>
                            <button class="profile-btn" data-profile="vivid_portraiture">Vivid Portrait</button>
                            <button class="profile-btn" data-profile="magazine_editorial">Magazine Editorial</button>
                            <button class="profile-btn" data-profile="soft_pastel_portrait">Soft Pastel</button>
                        </div>
                    </div>

                    <!-- Category 7: Everyday Enhancement -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-4" tabindex="0">
                            <span>Everyday Enhancement</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-4" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="general_style">General</button>
                            <button class="profile-btn" data-profile="faithful">Minimal</button>
                            <button class="profile-btn" data-profile="hyper_real_clean_edit">Hyper Real</button>
                            <button class="profile-btn" data-profile="ultra_hq_style_1">Ultra HQ v1</button>
                            <button class="profile-btn" data-profile="ultra_hq_style_2">Ultra HQ v2</button>
                            <button class="profile-btn" data-profile="extreme_hdr_pop">HDR Pop</button>
                            <button class="profile-btn" data-profile="fast">Fast Preview</button>
                        </div>
                    </div>

                    <!-- Category 8: Products & Marketing -->
                    <div class="profile-category">
                        <h3 class="profile-category-header" role="button" aria-expanded="false"
                            aria-controls="category-content-7" tabindex="0">
                            <span>Product & Detail</span>
                            <span class="header-arrow" aria-hidden="true">▼</span>
                        </h3>
                        <div id="category-content-7" class="profile-buttons profile-category-content">
                            <button class="profile-btn" data-profile="product">Product</button>
                            <button class="profile-btn" data-profile="ultra_clean_product">Clean Product</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resolution -->
            <div class="settings-section">
                <h2>Resolution</h2>
                <div class="control-group">
                    <div class="optional-control" style="margin-bottom: 10px;">
                        <div class="label-wrapper">
                            <input type="checkbox" id="adjust-resolution-checkbox" checked>
                            <label for="adjust-resolution-checkbox"
                                title="Automatically set the output resolution to match the uploaded image's dimensions.">Automatically
                                Adjust</label>
                        </div>
                    </div>
                    <div class="resolution-inputs">
                        <input type="number" id="width-input" min="256" max="2048" step="64" value="1024">
                        <span>×</span>
                        <input type="number" id="height-input" min="256" max="2048" step="64" value="1024">
                    </div>
                </div>
            </div>

            <!-- Prompt and Advanced Settings -->
            <div class="settings-section">
                <div class="control-group">
                    <label for="prompt-input" title="Describe the style you want to generate.">Prompt</label>
                    <textarea id="prompt-input" rows="6"></textarea>
                </div>

                <div id="advanced-settings-header" class="section-header" aria-expanded="false"
                    title="Toggle Advanced Settings">
                    <h2>Advanced Settings</h2>
                    <span class="header-arrow" aria-hidden="true">▼</span>
                </div>

                <div id="advanced-settings-content">
                    <div class="control-group optional-control">
                        <div class="label-wrapper">
                            <input type="checkbox" id="prompt-2-enabled">
                            <label for="prompt-2-enabled"
                                title="A secondary prompt for adding quality/style keywords.">Secondary Prompt</label>
                        </div>
                        <textarea id="prompt-2-input" rows="2"></textarea>
                    </div>

                    <div class="control-group optional-control">
                        <div class="label-wrapper">
                            <input type="checkbox" id="negative-prompt-enabled">
                            <label for="negative-prompt-enabled" title="Describe what you DON'T want to see.">Negative
                                Prompt</label>
                        </div>
                        <textarea id="negative-prompt-input" rows="2"></textarea>
                    </div>

                    <div class="control-group optional-control">
                        <div class="label-wrapper">
                            <input type="checkbox" id="negative-prompt-2-enabled">
                            <label for="negative-prompt-2-enabled"
                                title="A secondary negative prompt for excluding artifacts.">Secondary Negative
                                Prompt</label>
                        </div>
                        <textarea id="negative-prompt-2-input" rows="2"></textarea>
                    </div>

                    <div class="control-group">
                        <label for="steps-slider" title="More steps can improve quality but take longer.">Inference
                            Steps: <span id="steps-value">40</span></label>
                        <div class="slider-container">
                            <input type="range" id="steps-slider" min="10" max="100" value="40">
                            <input type="number" id="steps-number" min="10" max="100" value="40">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="guidance-slider" title="How strongly the model should follow the prompt.">Guidance
                            Scale: <span id="guidance-value">3.5</span></label>
                        <div class="slider-container">
                            <input type="range" id="guidance-slider" min="1" max="10" step="0.1" value="3.5">
                            <input type="number" id="guidance-number" min="1" max="10" step="0.1" value="3.5">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="cfg-slider" title="A secondary guidance scale for better prompt adherence.">True CFG
                            Scale: <span id="cfg-value">1.5</span></label>
                        <div class="slider-container">
                            <input type="range" id="cfg-slider" min="1" max="5" step="0.1" value="1.5">
                            <input type="number" id="cfg-number" min="1" max="5" step="0.1" value="1.5">
                        </div>
                    </div>

                    <div class="control-group optional-control">
                        <div class="label-wrapper">
                            <input type="checkbox" id="use-specific-seed-checkbox">
                            <label for="use-specific-seed-checkbox"
                                title="Check to use a specific seed for reproducible results. Unchecked uses a random seed.">Use
                                Specific Seed</label>
                        </div>
                        <input type="number" id="seed-input" placeholder="Random">
                    </div>
                </div>
            </div>

            <!-- Custom Profile Management -->
            <div class="settings-section custom-profiles-section">
                <h2>Custom Profiles</h2>
                <div class="control-group">
                    <label for="custom-profile-select">Load Profile</label>
                    <div class="profile-action-group">
                        <select id="custom-profile-select" title="Load a saved custom profile">
                            <option value="">-- Load a Profile --</option>
                        </select>
                        <button id="delete-profile-btn" class="btn btn-secondary"
                            title="Delete Selected Profile">Delete</button>
                    </div>
                </div>
                <div class="control-group">
                    <label for="save-profile-name">Save New Profile</label>
                    <div class="profile-action-group">
                        <input type="text" id="save-profile-name" placeholder="New Profile Name"
                            title="Enter a name to save current settings as a new profile">
                        <button id="save-profile-btn" class="btn btn-secondary"
                            title="Save Current Settings as a New Profile">Save</button>
                    </div>
                </div>
            </div>

            <!-- Default Settings Management -->
            <div class="settings-section action-buttons">
                <button id="save-defaults-btn" class="btn btn-secondary"><strong>Save as My Default</strong></button>
                <button id="reset-defaults-btn" class="btn btn-secondary"><strong>Reset App Default</strong></button>
            </div>
        </aside>
    </div>

    <!-- Error Toast Notification -->
    <div id="error-toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // **** CHANGE: Point to the base URL of the API ****
            const API_BASE_URL = 'http://127.0.0.1:5000';
            const CUSTOM_PROFILES_KEY = 'aiStylizerCustomProfiles';
            const POLLING_INTERVAL_MS = 2000; // Poll for status every 2 seconds
            const POLLING_TIMEOUT_MS = 300000; // 5 minutes

            // --- DOM ELEMENT REFERENCES ---
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const imagePreview = document.getElementById('image-preview');
            const loader = document.getElementById('loader');
            const loaderText = document.querySelector('#loader p');
            const errorToast = document.getElementById('error-toast');
            const cancelUploadBtn = document.getElementById('cancel-upload-btn');

            const applyBtn = document.getElementById('apply-btn');
            const downloadBtn = document.getElementById('download-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            const profileButtons = document.querySelectorAll('.profile-btn');
            const saveDefaultsBtn = document.getElementById('save-defaults-btn');
            const resetDefaultsBtn = document.getElementById('reset-defaults-btn');

            // Advanced Settings Toggle
            const advancedSettingsHeader = document.getElementById('advanced-settings-header');
            const advancedSettingsContent = document.getElementById('advanced-settings-content');

            // Custom Profile UI
            const customProfileSelect = document.getElementById('custom-profile-select');
            const deleteProfileBtn = document.getElementById('delete-profile-btn');
            const saveProfileNameInput = document.getElementById('save-profile-name');
            const saveProfileBtn = document.getElementById('save-profile-btn');

            // Control Inputs
            const promptInput = document.getElementById('prompt-input');
            const prompt2Input = document.getElementById('prompt-2-input');
            const prompt2Enabled = document.getElementById('prompt-2-enabled');
            const negativePromptInput = document.getElementById('negative-prompt-input');
            const negativePromptEnabled = document.getElementById('negative-prompt-enabled');
            const negativePrompt2Input = document.getElementById('negative-prompt-2-input');
            const negativePrompt2Enabled = document.getElementById('negative-prompt-2-enabled');

            const widthInput = document.getElementById('width-input');
            const heightInput = document.getElementById('height-input');
            const adjustResolutionCheckbox = document.getElementById('adjust-resolution-checkbox');

            const stepsSlider = document.getElementById('steps-slider');
            const stepsValue = document.getElementById('steps-value');
            const stepsNumber = document.getElementById('steps-number');
            const guidanceSlider = document.getElementById('guidance-slider');
            const guidanceValue = document.getElementById('guidance-value');
            const guidanceNumber = document.getElementById('guidance-number');
            const cfgSlider = document.getElementById('cfg-slider');
            const cfgValue = document.getElementById('cfg-value');
            const cfgNumber = document.getElementById('cfg-number');
            const useSpecificSeedCheckbox = document.getElementById('use-specific-seed-checkbox');
            const seedInput = document.getElementById('seed-input');

            // --- STATE MANAGEMENT ---
            let originalFile = null;
            let history = [];
            let historyIndex = -1;
            let pollingIntervalId = null;

            // --- START: NEW PROFILES & DEFAULTS ---
            // --- FLUX KONTEXT DEV OPTIMIZED PROFILES ---
            // Based on community research and official documentation
            // Key principles:
            // - Guidance 2-4 for creative freedom, 6-7 for literal edits
            // - true_cfg_scale ~1.0 unless negative prompts needed (then 1.25-1.5; ~1.5 max)
            // - 28-35 steps optimal (guidance-distilled model converges fast)
            // - Max area 1024² (1,048,576 px²)

            const APP_DEFAULTS = {
                prompt: "enhance the scene with vibrant colors and beautiful lighting, maintain original composition and subject identity, professional quality",
                prompt_2: "sharp details, masterpiece quality, enhanced clarity",
                negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish",
                negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                width: 1024,
                height: 1024,
                adjust_resolution: true,
                steps: 28,
                guidance: 3.5,
                cfg: 1.0,
                seed: '',
            };

            const PROFILES = {
                // === EXISTING PROFILES (OPTIMIZED) ===

                // General profile (previously 'default')
                general_style: {
                    ...APP_DEFAULTS,
                    guidance: 3.8, // Slightly higher for general pop
                    steps: 32,
                    prompt_2_enabled: true,
                    negative_prompt_enabled: true,
                    negative_prompt_2_enabled: true,
                    use_specific_seed: false,
                },

                // Style Transfer - Ghibli Style #1
                ghibli_style_1: {
                    prompt: "transform into Studio Ghibli anime style, hand-painted watercolor aesthetic, soft pastel palette, whimsical atmosphere, preserve subject identity and scene composition",
                    prompt_2: "painterly brushstrokes, dreamy color grading, cinematic composition, Miyazaki-inspired backgrounds",
                    negative_prompt: "photorealistic, 3D rendering, harsh lighting, modern digital look, sharp edges, jpeg artefacts, noisy",
                    negative_prompt_2: "plastic textures, CGI artifacts, oversaturated neon colors, blur, washed-out",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 34, guidance: 3.5, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Style Transfer - Ghibli Style #2
                ghibli_style_2: {
                    prompt: "lush hand-painted scenery in Studio Ghibli style, warm diffused sunlight, gentle film grain, masterpiece illustration with nature spirits",
                    prompt_2: "anime cel-shading, vibrant earth tones, cinematic composition, traditional animation feel",
                    negative_prompt: "photorealistic, jpeg artifacts, moiré, watermark, text, washed-out colors, distorted features",
                    negative_prompt_2: "low-detail, overexposed, underexposed, digital artifacts, blur, unnatural skin",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 32, guidance: 3.2, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false,
                },

                // Style Transfer - Cyberpunk Style #1
                cyberpunk_style_1: {
                    prompt: "transform into neon-drenched cyberpunk aesthetic, rain-slicked reflective streets, holographic advertisements, preserve subject identity in dystopian setting",
                    prompt_2: "electric cyan and hot magenta accents, noir atmosphere, Blade Runner 2049 color grading",
                    negative_prompt: "daylight, pastoral, low-tech, muted palette, rural elements, jpeg artefacts",
                    negative_prompt_2: "washed-out neon, desaturated, flat lighting, blur, low contrast",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 33, guidance: 3.8, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Style Transfer - Cyberpunk Style #2 (Retro)
                cyberpunk_style_2: {
                    prompt: "retro-futuristic poster design, distressed texture with speckled noise, aged paper with electric cyan and deep magenta accents, high-contrast silhouettes",
                    prompt_2: "screen-print texture, halftone dots, sharp ink edges, limited color palette, underground zine aesthetic",
                    negative_prompt: "photorealistic, glossy surfaces, modern gradients, oversaturation, blur",
                    negative_prompt_2: "compression blocks, color banding, digital smoothing, jpeg artefacts",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 30, guidance: 3.5, cfg: 1.3,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Fast Preview Mode
                fast: {
                    prompt: "quick enhancement, improve lighting and colors, preserve original composition",
                    prompt_2: "clean result, balanced exposure",
                    negative_prompt: "artifacts, noise, distortion, blur, watermark, text",
                    negative_prompt_2: null,
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 20, guidance: 2.5, cfg: 1.0,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: false, use_specific_seed: false
                },

                // Ultra HQ Style #1
                ultra_hq_style_1: {
                    prompt: "enhance to ultra high quality, professional medium format camera standard, maintain exact subject features, flawless detail clarity",
                    prompt_2: "8K resolution clarity, advanced lighting simulation, cinematic grade, sharp details, masterpiece quality",
                    negative_prompt: "soft focus, amateur look, flat lighting, chromatic aberration, jpeg artefacts, washed-out colours, distorted features, low detail, noisy",
                    negative_prompt_2: "lens distortion, motion blur, compression artifacts, color banding, oversaturated",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 42, guidance: 6.2, cfg: 1.3,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Ultra HQ Style #2
                ultra_hq_style_2: {
                    prompt: "ultra-detailed cinematic still, razor-sharp edges, subtle film emulsion texture, rich micro-contrast throughout, photorealistic restoration",
                    prompt_2: "IMAX camera clarity, volumetric rim lighting, photoreal surface texturing",
                    negative_prompt: "soft focus, skin smoothing, jpeg artefacts, watermark, grain, washed-out colours, distorted features, low detail, oversaturated, noisy",
                    negative_prompt_2: "posterization, color banding, oversharpening halos, blur, unnatural skin",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 38, guidance: 6.0, cfg: 1.4,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false,
                },

                // Artistic Style #1
                artistic_style_1: {
                    prompt: "expressive fine art transformation, bold impasto brushstrokes, vivid complementary colors, emotional impact, retain subject recognition",
                    prompt_2: "museum-quality presentation, dynamic composition, unique artistic vision, textured canvas",
                    negative_prompt: "photographic literalism, mundane appearance, flat tones, digital precision, jpeg artefacts",
                    negative_prompt_2: "generic filters, uninspired composition, washed-out",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 35, guidance: 4.0, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Artistic Style #2 (Creative/Surreal)
                artistic_style_2: {
                    prompt: "surreal dreamscape transformation, unexpected color harmonies, abstract geometric shapes, mixed media collage aesthetic",
                    prompt_2: "experimental techniques, controlled chaos, gallery-worthy innovation",
                    negative_prompt: "photorealism, literal interpretation, muted palette, conventional composition",
                    negative_prompt_2: "jpeg artefacts, blur, washed-out colors",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 34, guidance: 2.8, cfg: 1.15,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false,
                },

                // Portrait Enhancement
                portrait: {
                    prompt: "enhance portrait photography, natural skin texture with subtle retouching, professional studio lighting, preserve exact identity and expression",
                    prompt_2: "Vogue magazine clarity, flattering Rembrandt lighting, authentic skin tones",
                    negative_prompt: "plastic skin, altered facial features, overprocessed smoothing, uncanny valley, jpeg artefacts, washed-out colours, distorted features",
                    negative_prompt_2: "harsh shadows, unnatural skin texture, aggressive beauty filters, blur, color banding",
                    width: 768, height: 1024, adjust_resolution: true,
                    steps: 32, guidance: 3.2, cfg: 1.1,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Landscape/Environment
                landscape: {
                    prompt: "enhance landscape photography, dramatic cloud formations, golden hour warmth, preserve natural composition",
                    prompt_2: "National Geographic standard, epic vista scope, atmospheric perspective depth",
                    negative_prompt: "flat lighting, dull colors, haze, urban intrusion, oversaturation, jpeg artefacts, low detail, noisy",
                    negative_prompt_2: "blown highlights, crushed shadows, blur, washed-out",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 34, guidance: 3.2, cfg: 1.15,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Vintage/Film
                vintage: {
                    prompt: "authentic vintage film photography look, organic grain structure, nostalgic color grading with slight fade, subtle vignetting",
                    prompt_2: "35mm film aesthetic, Kodak Portra 400 color science, timeless quality",
                    negative_prompt: "digital clarity, neon colors, HDR processing, modern sharpness, jpeg artefacts, distorted features",
                    negative_prompt_2: "perfect pixels, contemporary editing, blur, color banding",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 33, guidance: 3.0, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Faithful/Minimal Edit
                faithful: {
                    prompt: "subtle enhancement only, correct minor noise and lighting, maintain exact original appearance, preserve all details with minimal processing",
                    prompt_2: "true to original, clean result, balanced tones",
                    negative_prompt: "artistic deviation, heavy stylization, dramatic changes, color shift, distortion",
                    negative_prompt_2: null,
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 28, guidance: 2.0, cfg: 1.0,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: false, use_specific_seed: false
                },

                // Monochrome/B&W
                monochrome: {
                    prompt: "convert to fine art black and white photography, rich tonal range from deep blacks to bright whites, film noir aesthetic, high contrast",
                    prompt_2: "Ansel Adams zone system, silver gelatin print quality, dramatic contrast, detailed shadows",
                    negative_prompt: "color artifacts, muddy gray tones, flat contrast, washed-out, sepia",
                    negative_prompt_2: "color bleeding, poor tonal separation, low contrast",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 32, guidance: 3.2, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Fantasy/Magical
                fantasy: {
                    prompt: "transform into magical fantasy scene, ethereal bioluminescent lighting, floating mystical particles, preserve character identity in enchanted setting",
                    prompt_2: "aurora borealis effects, crystalline structures, storybook illustration quality, otherworldly atmosphere",
                    negative_prompt: "mundane realism, modern technology, harsh fluorescent light, everyday objects, jpeg artefacts",
                    negative_prompt_2: "scientific accuracy, photographic literalism, blur, washed-out colors",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 38, guidance: 3.8, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // Product/Commercial
                product: {
                    prompt: "enhance for e-commerce catalog, perfect studio lighting, color-accurate reproduction, tack-sharp detail, clean white background",
                    prompt_2: "professional product photography, luxury brand presentation, flawless finish",
                    negative_prompt: "harsh shadows, unwanted reflections, background clutter, color cast, jpeg artefacts, low detail, noisy",
                    negative_prompt_2: "uneven exposure, amateur lighting setup, dust or imperfections, blur, distortion",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 35, guidance: 6.5, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // === START: ADDED NEW PROFILES ===
                vivid_portraiture: {
                    prompt: "hyper-realistic portrait, vibrant lighting, accurate skin tones, cinematic mood, eyes in sharp focus, background soft blur, what not to change: subject's face and identity",
                    prompt_2: "masterpiece, sharp details, color graded, enhanced clarity",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.2, cfg: 1.0, steps: 32,
                    width: 768, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                magazine_editorial: {
                    prompt: "high-fashion editorial, clean lines, professional retouching, balanced colors, dramatic lighting, bold composition, what not to change: subject's face and clothes",
                    prompt_2: "crisp detail, balanced tones, masterpiece",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.8, cfg: 1.0, steps: 32,
                    width: 768, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                retro_film_grain: {
                    prompt: "vintage photo, 1970s film grain, warm tones, slightly faded, soft highlight rolloff, what not to change: main subject and composition",
                    prompt_2: "subtle grain, analog style, nostalgic look, Kodak Ektachrome color science",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, digital look",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast, sharp digital details",
                    guidance: 2.6, cfg: 1.0, steps: 28,
                    width: 1024, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                classic_black_and_white: {
                    prompt: "timeless black and white, high contrast, rich midtones, detailed shadows, no color, what not to change: scene structure",
                    prompt_2: "film noir, deep blacks, crisp whites, Ansel Adams zone system",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, color, sepia",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast, muddy greys",
                    guidance: 3.0, cfg: 1.0, steps: 32,
                    width: 1024, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                futurist_neon: {
                    prompt: "cyberpunk aesthetic, neon lighting, vibrant magenta and cyan, dramatic shadows, futuristic city background, what not to change: subject identity and pose",
                    prompt_2: "high contrast, glowing lights, sharp detail, Blade Runner aesthetic",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, natural lighting, daytime",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.5, cfg: 1.0, steps: 32,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                watercolor_dreamscape: {
                    prompt: "ethereal watercolor painting, soft edges, pastel colors, dreamy atmosphere, painterly brushstrokes on textured paper",
                    prompt_2: "delicate detail, hand-painted look, wet-on-wet technique",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, photorealistic, sharp edges, digital look",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast, oil painting, acrylic",
                    guidance: 2.5, cfg: 1.0, steps: 28,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                ultra_clean_product: {
                    prompt: "flawless product photo, pure white background, perfect focus, balanced commercial lighting, commercial clarity, what not to change: the product itself",
                    prompt_2: "studio shot, crisp lines, high definition, color accurate",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, pixelated, noisy, compression artefacts, cartoonish, shadows, background clutter",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, low contrast, dust, scratches",
                    guidance: 6.5, cfg: 1.0, steps: 35,
                    width: 1024, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                golden_hour_glow: {
                    prompt: "outdoor scene during sunset golden hour, warm light, glowing highlights, natural skin, what not to change: original composition and subjects",
                    prompt_2: "backlit, cinematic, soft shadows, lens flare",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, harsh shadows, daytime, blue light",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.0, cfg: 1.0, steps: 32,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                moody_cinematic: {
                    prompt: "cinematic frame, moody atmosphere, dramatic color grading with deep blues and oranges, filmic contrast, what not to change: scene structure and subject identity",
                    prompt_2: "soft haze, sharp focus on subject, enhanced drama, anamorphic look",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, bright, happy, flat lighting",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.7, cfg: 1.0, steps: 32,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                hyper_real_clean_edit: {
                    prompt: "ultra-clean photo edit, neutral colors, extremely sharp details, perfect skin, flawless professional finish, what not to change: subject's facial features and identity",
                    prompt_2: "studio lighting, high clarity, commercial quality, tack sharp",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, blur, softness",
                    negative_prompt_2: "posterized, color banding, excessive smoothing, extra limbs, low contrast",
                    guidance: 4.2, cfg: 1.0, steps: 35,
                    width: 768, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                painterly_renaissance: {
                    prompt: "old master painting, renaissance portrait, rich oil colors, soft brushwork (sfumato), dramatic light and shadow (chiaroscuro)",
                    prompt_2: "classic art, fine canvas texture, historical look, da Vinci style",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, pixelated, noisy, compression artefacts, cartoonish, photorealistic, modern",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, extra limbs, low contrast, digital art, photography",
                    guidance: 2.7, cfg: 1.0, steps: 32,
                    width: 768, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                soft_pastel_portrait: {
                    prompt: "portrait in a soft pastel palette, gentle lighting, smooth color gradients, airy and dreamy atmosphere, what not to change: subject's face",
                    prompt_2: "delicate skin tones, dreamy quality, subtle tones, high-key lighting",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, high contrast, dark shadows",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, extra limbs, low contrast",
                    guidance: 2.9, cfg: 1.0, steps: 28,
                    width: 768, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                night_cityscape: {
                    prompt: "night city skyline, glowing windows, crisp neon signs, sharp reflections on wet streets, deep shadows, clean architectural lines",
                    prompt_2: "high clarity, cinematic, enhanced detail, long exposure look",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, daytime, motion blur",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, extra limbs, low contrast, hazy",
                    guidance: 3.6, cfg: 1.0, steps: 32,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                ghibli_inspired: {
                    prompt: "transform into the style of Studio Ghibli, lush painted backgrounds, whimsical lighting, soft color gradients, magical realism",
                    prompt_2: "hand-painted anime, high detail, gentle tones, Miyazaki aesthetic",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, oversaturated, pixelated, noisy, compression artefacts, cartoonish, photorealistic, 3D render",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, washed-out, extra limbs, low contrast",
                    guidance: 3.1, cfg: 1.0, steps: 32,
                    width: 1024, height: 768, adjust_resolution: true, output_type: "pil", seed: "",
                },
                extreme_hdr_pop: {
                    prompt: "ultra-vibrant HDR effect, extreme dynamic range, saturated colors, punchy highlights and deep shadows, surreal detail, what not to change: composition",
                    prompt_2: "hyper-real, crisp edges, enhanced depth, dramatic look",
                    negative_prompt: "jpeg artefacts, grid pattern, washed-out colours, distorted features, low detail, unnatural skin, pixelated, noisy, compression artefacts, cartoonish, flat, dull, monochrome, realistic",
                    negative_prompt_2: "blur, posterized, color banding, excessive smoothing, extra limbs, low contrast",
                    guidance: 4.4, cfg: 1.0, steps: 32,
                    width: 1024, height: 1024, adjust_resolution: true, output_type: "pil", seed: "",
                },
                // === END: ADDED NEW PROFILES ===

                // === 15 NEW PROFILES ===

                // 1. Oil Painting Master
                oil_painting: {
                    prompt: "transform into classical oil painting, thick impasto technique with visible brushstrokes, Rembrandt lighting, preserve subject identity as painted portrait",
                    prompt_2: "old master technique, glazing layers, rich earth tones, museum-quality fine art",
                    negative_prompt: "digital art, flat colors, photographic elements, modern style",
                    negative_prompt_2: "smooth blending, airbrush effect, contemporary techniques",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 36, guidance: 4.2, cfg: 1.3,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 2. Watercolor Dream
                watercolor: {
                    prompt: "delicate watercolor painting style, transparent washes with color bleeding, paper texture visible, soft ethereal quality, preserve scene composition",
                    prompt_2: "wet-on-wet technique, granulation effects, artistic color mixing, gallery-quality artwork",
                    negative_prompt: "hard edges, opaque colors, digital precision, photographic detail",
                    negative_prompt_2: "oil paint thickness, acrylic flatness, marker strokes",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 33, guidance: 3.0, cfg: 1.15,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 3. Noir Detective
                noir_detective: {
                    prompt: "1940s film noir aesthetic, dramatic venetian blind shadows, cigarette smoke atmosphere, high contrast black and white, preserve subject as noir character",
                    prompt_2: "detective story mood, rain-wet streets, vintage Hollywood cinematography, mystery atmosphere",
                    negative_prompt: "color elements, modern settings, bright lighting, contemporary fashion",
                    negative_prompt_2: "digital clarity, happy mood, daylight scenes",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 32, guidance: 3.5, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 4. Ukiyo-e Japanese
                ukiyo_e: {
                    prompt: "traditional Japanese ukiyo-e woodblock print style, flat color areas with bold outlines, wave patterns, preserve subject in Edo period aesthetic",
                    prompt_2: "Hokusai and Hiroshige influence, limited color palette, decorative elements, artistic simplification",
                    negative_prompt: "photorealistic shading, Western perspective, modern elements, gradient fills",
                    negative_prompt_2: "3D depth, realistic textures, contemporary style",
                    width: 768, height: 1024, adjust_resolution: true,
                    steps: 34, guidance: 3.8, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 5. Synthwave Retro
                synthwave: {
                    prompt: "80s synthwave aesthetic, neon grid landscape, purple and pink sunset, chrome reflections, transform scene into retro-futuristic paradise",
                    prompt_2: "Miami Vice color palette, laser grids, palm tree silhouettes, VHS scan lines, vintage arcade glow",
                    negative_prompt: "natural colors, realistic lighting, modern design, muted tones",
                    negative_prompt_2: "photographic realism, contemporary elements, desaturated colors",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 32, guidance: 3.5, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 6. Renaissance Portrait
                renaissance: {
                    prompt: "Renaissance master painting style, sfumato technique, classical composition, rich velvet and brocade textures, transform subject into nobility",
                    prompt_2: "Leonardo da Vinci lighting, oil on canvas texture, gold leaf accents, period-accurate details",
                    negative_prompt: "modern clothing, contemporary hairstyles, digital artifacts, harsh lighting",
                    negative_prompt_2: "photographic elements, casual poses, modern backgrounds",
                    width: 896, height: 1152, adjust_resolution: true,
                    steps: 38, guidance: 4.5, cfg: 1.35,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 7. Comic Book Hero
                comic_book: {
                    prompt: "dynamic comic book art style, bold ink outlines, Ben Day dots, action poses with motion lines, transform into superhero scene",
                    prompt_2: "Marvel and DC aesthetic, dramatic angles, speech bubble space, vibrant primary colors",
                    negative_prompt: "photorealism, subtle shading, muted colors, static composition",
                    negative_prompt_2: "realistic proportions, natural lighting, fine details",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 30, guidance: 3.2, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 8. Impressionist Light
                impressionist: {
                    prompt: "French Impressionist painting style, broken color technique, capture fleeting light effects, outdoor scene en plein air, preserve scene essence",
                    prompt_2: "Monet and Renoir influence, visible brushstrokes, luminous shadows, atmospheric perspective",
                    negative_prompt: "sharp details, photographic precision, dark palette, indoor lighting",
                    negative_prompt_2: "smooth blending, technical accuracy, muted colors",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 35, guidance: 3.5, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 9. Steampunk Victorian
                steampunk: {
                    prompt: "Victorian steampunk transformation, brass gears and copper pipes, steam-powered machinery, goggles and corsets, preserve subject in alternate history",
                    prompt_2: "sepia tones with metallic highlights, industrial revolution aesthetic, clockwork details, airship atmosphere",
                    negative_prompt: "modern technology, plastic materials, neon colors, minimalist design",
                    negative_prompt_2: "contemporary fashion, digital displays, sleek surfaces",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 36, guidance: 3.8, cfg: 1.3,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 10. Art Deco Elegance
                art_deco: {
                    prompt: "Art Deco style transformation, geometric patterns, gold and black palette, 1920s glamour, transform into Great Gatsby era elegance",
                    prompt_2: "streamlined forms, metallic accents, symmetric composition, luxury materials, Jazz Age sophistication",
                    negative_prompt: "organic shapes, rough textures, casual elements, contemporary style",
                    negative_prompt_2: "natural patterns, rustic materials, asymmetric design",
                    width: 896, height: 1152, adjust_resolution: true,
                    steps: 34, guidance: 3.5, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 11. Double Exposure
                double_exposure: {
                    prompt: "artistic double exposure effect, silhouette filled with secondary scene, dreamy overlay blending, preserve main subject as primary layer",
                    prompt_2: "transparent layering, poetic visual metaphor, professional photography technique, seamless integration",
                    negative_prompt: "harsh edges, poor blending, cluttered composition, conflicting elements",
                    negative_prompt_2: "opaque overlays, misaligned layers, amateur execution",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 35, guidance: 3.2, cfg: 1.2,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 12. Pop Art Bold
                pop_art: {
                    prompt: "Andy Warhol pop art style, bold color blocks, high contrast screenprint effect, repeat pattern potential, transform into iconic pop art",
                    prompt_2: "Roy Lichtenstein influence, commercial art aesthetic, saturated CMYK colors, cultural icon treatment",
                    negative_prompt: "subtle gradients, realistic shading, muted colors, traditional composition",
                    negative_prompt_2: "fine art pretension, complex details, natural colors",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 30, guidance: 3.0, cfg: 1.15,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 13. Infrared Photography
                infrared: {
                    prompt: "infrared photography effect, white foliage with dark skies, ethereal false color mapping, otherworldly landscape transformation",
                    prompt_2: "surreal color inversion, heat signature aesthetic, scientific imaging beauty, unique spectrum shift",
                    negative_prompt: "normal color spectrum, standard photography, realistic vegetation colors",
                    negative_prompt_2: "conventional sky colors, typical green plants",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 32, guidance: 3.5, cfg: 1.25,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 14. Brutalist Architecture
                brutalist: {
                    prompt: "brutalist architectural style, raw concrete textures, monolithic geometric forms, dramatic shadows, transform scene into brutalist monument",
                    prompt_2: "fortress-like presence, minimalist power, urban dystopia aesthetic, architectural photography",
                    negative_prompt: "ornate details, soft curves, colorful elements, decorative features",
                    negative_prompt_2: "delicate structures, natural materials, human scale",
                    width: 1024, height: 1024, adjust_resolution: true,
                    steps: 34, guidance: 3.8, cfg: 1.3,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                },

                // 15. Tilt-Shift Miniature
                tilt_shift: {
                    prompt: "tilt-shift photography effect, miniature world illusion, selective focus with blur gradient, toy-like saturation, transform into diorama scene",
                    prompt_2: "model railway aesthetic, heightened colors, shallow depth of field, whimsical scale distortion",
                    negative_prompt: "full sharp focus, natural scale, muted colors, realistic perspective",
                    negative_prompt_2: "normal depth of field, true-to-life proportions",
                    width: 1024, height: 768, adjust_resolution: true,
                    steps: 30, guidance: 2.8, cfg: 1.1,
                    prompt_2_enabled: true, negative_prompt_enabled: true, negative_prompt_2_enabled: true, use_specific_seed: false
                }
            };

            const PROFILE_CATEGORIES = {
                'Enhancement & Utility': [
                    'general_style', 'portrait', 'landscape', 'product', 'ultra_hq_style_1', 'ultra_hq_style_2',
                    'faithful', 'infrared', 'tilt_shift', 'hyper_real_clean_edit', 'extreme_hdr_pop',
                    'ultra_clean_product', 'fast'
                ],
                'Portrait & People': [
                    'portrait', 'vivid_portraiture', 'magazine_editorial', 'soft_pastel_portrait'
                ],
                'Landscape & Scene': [
                    'landscape', 'golden_hour_glow', 'moody_cinematic', 'night_cityscape'
                ],
                'Artistic & Illustration': [
                    'artistic_style_1', 'artistic_style_2', 'oil_painting', 'watercolor',
                    'watercolor_dreamscape', 'impressionist', 'renaissance', 'painterly_renaissance',
                    'pop_art', 'double_exposure'
                ],
                'Animation & Style Transfer': [
                    'ghibli_style_1', 'ghibli_style_2', 'ghibli_inspired', 'ukiyo_e', 'comic_book'
                ],
                'Period & Culture': [
                    'vintage', 'art_deco', 'noir_detective', 'steampunk', 'retro_film_grain',
                    'classic_black_and_white', 'monochrome'
                ],
                'Sci-Fi, Futuristic & Fantasy': [
                    'cyberpunk_style_1', 'cyberpunk_style_2', 'synthwave', 'brutalist',
                    'futurist_neon', 'fantasy'
                ]
            };

            function getProfilesByCategory(category) {
                return PROFILE_CATEGORIES[category] || [];
            }
            // --- END: NEW PROFILES & DEFAULTS ---


            // --- CORE FUNCTIONS ---

            // EDIT 2: Save the state of all fields, including unchecked/hidden ones.
            const getCurrentSettings = () => {
                return {
                    prompt: promptInput.value,
                    prompt_2: prompt2Input.value,
                    prompt_2_enabled: prompt2Enabled.checked,
                    negative_prompt: negativePromptInput.value,
                    negative_prompt_enabled: negativePromptEnabled.checked,
                    negative_prompt_2: negativePrompt2Input.value,
                    negative_prompt_2_enabled: negativePrompt2Enabled.checked,
                    width: Number(widthInput.value),
                    height: Number(heightInput.value),
                    adjust_resolution: adjustResolutionCheckbox.checked,
                    steps: Number(stepsSlider.value),
                    guidance: Number(guidanceSlider.value),
                    cfg: Number(cfgSlider.value),
                    seed: seedInput.value,
                    use_specific_seed: useSpecificSeedCheckbox.checked,
                };
            };

            // EDIT 2: Update UI based on the full saved state.
            const updateControlsUI = (settings) => {
                promptInput.value = settings.prompt || '';

                // Handle optional fields with backward compatibility for old save format
                const setupOptional = (baseKey, inputEl, checkboxEl) => {
                    const enabledKey = `${baseKey}_enabled`;
                    const value = settings[baseKey];
                    inputEl.value = value || '';

                    if (settings.hasOwnProperty(enabledKey)) {
                        checkboxEl.checked = settings[enabledKey]; // New format with explicit flag
                    } else {
                        checkboxEl.checked = value !== null && value !== undefined && value !== ''; // Old format
                    }
                    inputEl.disabled = !checkboxEl.checked;
                };

                setupOptional('prompt_2', prompt2Input, prompt2Enabled);
                setupOptional('negative_prompt', negativePromptInput, negativePromptEnabled);
                setupOptional('negative_prompt_2', negativePrompt2Input, negativePrompt2Enabled);

                // Handle seed field
                seedInput.value = settings.seed || '';
                if (settings.hasOwnProperty('use_specific_seed')) {
                    useSpecificSeedCheckbox.checked = settings.use_specific_seed;
                } else {
                    useSpecificSeedCheckbox.checked = !!settings.seed;
                }
                seedInput.disabled = !useSpecificSeedCheckbox.checked;

                widthInput.value = settings.width || 1024;
                heightInput.value = settings.height || 1024;

                // NEW: Handle adjust resolution checkbox
                // Default to true if the property doesn't exist (for old profiles)
                adjustResolutionCheckbox.checked = settings.adjust_resolution !== false;
                const isChecked = adjustResolutionCheckbox.checked;
                widthInput.disabled = isChecked;
                heightInput.disabled = isChecked;

                stepsSlider.value = stepsNumber.value = stepsValue.textContent = settings.steps || 40;
                guidanceSlider.value = guidanceNumber.value = guidanceValue.textContent = settings.guidance || 3.5;
                cfgSlider.value = cfgNumber.value = cfgValue.textContent = settings.cfg || 1.5;
            };

            // EDIT 3: Helper function to compare two settings objects.
            const areSettingsEqual = (obj1, obj2) => {
                return JSON.stringify(obj1) === JSON.stringify(obj2);
            };

            // NEW HELPER: Adjusts resolution inputs if the checkbox is checked and an image is loaded.
            const maybeAdjustResolution = () => {
                // Only run if an image is actually loaded (src is not empty and naturalWidth is valid)
                if (adjustResolutionCheckbox.checked && imagePreview.src && imagePreview.naturalWidth > 0) {
                    widthInput.value = imagePreview.naturalWidth;
                    heightInput.value = imagePreview.naturalHeight;
                }
            };

            // START: MODIFIED loadSettings FUNCTION
            const loadSettings = (profileKey = 'default') => {
                let settings;
                let isUserDefaultLoad = false;
                let effectiveProfileKey = profileKey; // ADDED: To track which button to highlight

                if (profileKey === 'default') {
                    const userDefaults = JSON.parse(localStorage.getItem('userDefaultSettings'));
                    if (userDefaults) {
                        settings = userDefaults;
                        isUserDefaultLoad = true;
                        showToast("Loaded your saved defaults.", true);
                    } else {
                        // CHANGED: This is the new app default
                        settings = PROFILES.ghibli_style_1;
                        effectiveProfileKey = 'ghibli_style_1'; // CHANGED: Set the key to match the loaded profile
                    }
                } else {
                    settings = PROFILES[profileKey];
                }

                updateControlsUI(settings);
                maybeAdjustResolution();

                // If loading a user's saved default, start with no style profile active.
                // The check below will select a custom profile if it matches.
                // If loading a preset (or the app's default), activate the corresponding button.
                if (isUserDefaultLoad) {
                    setActiveProfileButton(null);
                } else {
                    setActiveProfileButton(effectiveProfileKey); // CHANGED: Use the new variable
                }

                customProfileSelect.value = ""; // Always reset dropdown before checking for a match.

                // If we loaded a user's default settings, check if they match a named custom profile.
                if (isUserDefaultLoad) {
                    const customProfiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                    const currentSettingsForCompare = getCurrentSettings();
                    for (const name in customProfiles) {
                        if (areSettingsEqual(currentSettingsForCompare, customProfiles[name])) {
                            customProfileSelect.value = name;
                            // Since we already called setActiveProfileButton(null), no further action is needed here.
                            break;
                        }
                    }
                }
            };
            // END: MODIFIED loadSettings FUNCTION

            // START: MODIFIED saveDefaults FUNCTION
            const saveDefaults = () => {
                if (!confirm("Are you sure you want to overwrite your saved default settings?")) return;

                // Get the current settings from the UI and save them as the user's default.
                const userDefaults = getCurrentSettings();
                localStorage.setItem('userDefaultSettings', JSON.stringify(userDefaults));

                // Provide feedback to the user.
                showToast("Your settings have been saved as the new default.", true);
                showButtonFeedback(saveDefaultsBtn);

                // --- START: NEW FEATURE IMPLEMENTATION ---
                // After saving, check if the new default settings match any saved custom profile.

                // 1. Retrieve all saved custom profiles.
                const customProfiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                let matchingProfileName = null;

                // 2. Iterate through the custom profiles to find a match.
                for (const profileName in customProfiles) {
                    if (areSettingsEqual(userDefaults, customProfiles[profileName])) {
                        matchingProfileName = profileName;
                        break; // Stop searching once a match is found.
                    }
                }

                // 3. Update the 'Load a Profile' dropdown.
                // If a match was found, select that profile. Otherwise, reset the dropdown.
                customProfileSelect.value = matchingProfileName || "";
                // --- END: NEW FEATURE IMPLEMENTATION ---
            };
            // END: MODIFIED saveDefaults FUNCTION

            const resetToAppDefaults = () => {
                if (!confirm("Are you sure you want to reset all settings to the application's original defaults?")) return;
                localStorage.removeItem('userDefaultSettings');
                // CHANGED: Use the ghibli_style_1 profile as the new app default.
                updateControlsUI(PROFILES.ghibli_style_1);
                setActiveProfileButton('ghibli_style_1');
                customProfileSelect.value = "";
                showToast("Settings have been reset to app defaults.", true);
            };

            // --- Custom Profile Functions ---
            const populateCustomProfiles = () => {
                const profiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                customProfileSelect.innerHTML = '<option value="">-- Load a Profile --</option>'; // Reset
                Object.keys(profiles).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    customProfileSelect.appendChild(option);
                });
            };

            const saveCustomProfile = () => {
                const name = saveProfileNameInput.value.trim();
                if (!name) {
                    showToast("Please enter a name for the profile.");
                    return;
                }
                const profiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                if (profiles[name] && !confirm(`A profile named "${name}" already exists. Overwrite it?`)) {
                    return;
                }
                profiles[name] = getCurrentSettings(); // Uses updated function
                localStorage.setItem(CUSTOM_PROFILES_KEY, JSON.stringify(profiles));
                populateCustomProfiles();
                customProfileSelect.value = name; // Select the newly saved profile
                saveProfileNameInput.value = '';
                showToast(`Profile "${name}" saved.`, true);
                showButtonFeedback(saveProfileBtn, 'Saved!');
            };

            const loadCustomProfile = () => {
                const name = customProfileSelect.value;
                if (!name) return;
                const profiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                if (profiles[name]) {
                    updateControlsUI(profiles[name]);
                    maybeAdjustResolution(); // NEW: Check if resolution needs adjusting after load
                    setActiveProfileButton(null); // Deselect preset profiles
                    showToast(`Loaded profile "${name}".`, true);
                }
            };

            const deleteCustomProfile = () => {
                const name = customProfileSelect.value;
                if (!name) {
                    showToast("Select a profile to delete.");
                    return;
                }
                if (!confirm(`Are you sure you want to delete the profile "${name}"?`)) {
                    return;
                }
                const profiles = JSON.parse(localStorage.getItem(CUSTOM_PROFILES_KEY) || '{}');
                delete profiles[name];
                localStorage.setItem(CUSTOM_PROFILES_KEY, JSON.stringify(profiles));
                populateCustomProfiles();
                showToast(`Profile "${name}" deleted.`, true);
            };

            // NEW: Function to reset the entire upload UI to its initial state
            const resetUploadUI = () => {
                originalFile = null;
                history = [];
                historyIndex = -1;

                imagePreview.src = ''; // Clear src to prevent flash of old image
                imagePreview.style.display = 'none';

                uploadArea.classList.remove('disabled');
                cancelUploadBtn.style.display = 'none';

                applyBtn.disabled = true;
                downloadBtn.disabled = true;
                updateHistoryButtons();
            };

            const handleFileUpload = (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    showToast("Error: Please upload a valid image file (PNG, JPG, etc).");
                    return;
                }
                originalFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // The 'load' event listener on imagePreview will handle resolution adjustment
                    imagePreview.src = imageUrl;
                    imagePreview.style.display = 'block';

                    // MODIFIED: Instead of hiding the upload area, disable it and show cancel button
                    uploadArea.classList.add('disabled');
                    cancelUploadBtn.style.display = 'inline-block';

                    history = [imageUrl];
                    historyIndex = 0;
                    updateHistoryButtons();
                    applyBtn.disabled = false;
                    downloadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            };

            // **** MAJOR CHANGE: Rewritten to handle the async API with polling ****
            const applyEdits = async () => {
                if (!originalFile) {
                    showToast("Please upload an image first.");
                    return;
                }
                // --- UI updates for processing start ---

                loader.style.display = 'flex';
                loaderText.innerHTML = "Submitting job to the server...";
                applyBtn.disabled = true;

                // --- Prepare form data ---
                const formData = new FormData();
                formData.append('image', originalFile);
                const settings = getCurrentSettings();

                // Append all settings to FormData
                formData.append('prompt', settings.prompt);
                formData.append('width', settings.width);
                formData.append('height', settings.height);
                formData.append('num_inference_steps', settings.steps);
                formData.append('guidance_scale', settings.guidance);
                formData.append('true_cfg_scale', settings.cfg);

                if (settings.use_specific_seed && settings.seed) formData.append('seed', settings.seed);
                if (settings.prompt_2_enabled && settings.prompt_2) formData.append('prompt_2', settings.prompt_2);
                if (settings.negative_prompt_enabled && settings.negative_prompt) formData.append('negative_prompt', settings.negative_prompt);
                if (settings.negative_prompt_2_enabled && settings.negative_prompt_2) formData.append('negative_prompt_2', settings.negative_prompt_2);

                try {
                    // --- Step 1: Submit the job and get a job ID ---
                    const generateResponse = await fetch(`${API_BASE_URL}/process-image`, { method: 'POST', body: formData });
                    if (!generateResponse.ok) {
                        const errorData = await generateResponse.json();
                        throw new Error(errorData.error || `Server error: ${generateResponse.status}`);
                    }
                    const jobData = await generateResponse.json();
                    const jobId = jobData.job_id;
                    localStorage.setItem('activeJobId', jobId);

                    // --- Step 2: Poll for the job status ---
                    pollForJobCompletion(jobId);
                } catch (error) {
                    console.error('Submission Error:', error);
                    showToast(`Error: ${error.message}`);
                    loader.style.display = 'none';
                    applyBtn.disabled = false;
                }
            };

            const pollForJobCompletion = (jobId) => {
                const startTime = Date.now();
                pollingIntervalId = setInterval(async () => {
                    // --- Check for timeout ---
                    if (Date.now() - startTime > POLLING_TIMEOUT_MS) {
                        clearInterval(pollingIntervalId);
                        showToast("Error: The request timed out. The server might be too busy.");
                        loader.style.display = 'none';
                        applyBtn.disabled = false;
                        return;
                    }
                    try {
                        const statusResponse = await fetch(`${API_BASE_URL}/status/${jobId}`);
                        if (!statusResponse.ok) {
                            // If status check fails, stop polling to avoid loops
                            throw new Error(`Failed to get job status (HTTP ${statusResponse.status})`);
                        }
                        const statusData = await statusResponse.json();

                        // --- Update UI based on status ---
                        if (statusData.status === 'completed') {
                            clearInterval(pollingIntervalId);
                            loaderText.innerHTML = "Done! Retrieving image...";
                            await fetchAndDisplayResult(jobId);
                        } else if (statusData.status === 'failed') {
                            clearInterval(pollingIntervalId);
                            localStorage.removeItem('activeJobId');
                            throw new Error(statusData.error || "Job failed for an unknown reason.");
                        } else {
                            // Job is 'queued' or 'processing'
                            let statusMessage = `Status: <b>${statusData.status}</b>`;
                            if (statusData.queue_position) {
                                statusMessage += ` (Position: ${statusData.queue_position})`;
                            }
                            loaderText.innerHTML = statusMessage;
                        }
                    } catch (error) {
                        clearInterval(pollingIntervalId);
                        console.error('Polling Error:', error);
                        showToast(`Error: ${error.message}`);
                        loader.style.display = 'none';
                        applyBtn.disabled = false;
                    }
                }, POLLING_INTERVAL_MS);
            };

            const fetchAndDisplayResult = async (jobId) => {
                try {
                    const resultResponse = await fetch(`${API_BASE_URL}/result/${jobId}`);
                    if (!resultResponse.ok) {
                        throw new Error("Failed to fetch the final image.");
                    }
                    const imageBlob = await resultResponse.blob();

                    // --- Update the UI with the new image ---
                    const imageUrl = URL.createObjectURL(imageBlob);
                    history = history.slice(0, historyIndex + 1);
                    history.push(imageUrl);
                    historyIndex++;
                    imagePreview.src = imageUrl;
                    updateHistoryButtons();

                    // --- IMPORTANT: Update originalFile for iterative editing ---
                    // This allows the user to apply another style to the newly generated image
                    originalFile = new File([imageBlob], `stylized-${Date.now()}.png`, { type: 'image/png' });
                } catch (error) {
                    console.error('Result Fetch Error:', error);
                    showToast(`Error: ${error.message}`);
                } finally {
                    // --- Final UI cleanup ---
                    loader.style.display = 'none';
                    applyBtn.disabled = false;
                    localStorage.removeItem('activeJobId');
                }
            };

            // **** START FIX ****

            /**
             * Updates the `originalFile` variable based on the current history index.
             * This is crucial for ensuring that "Undo" and "Redo" actions correctly
             * set the source image for the next "Apply Style" operation.
             */
            const updateSourceImageFromHistory = async () => {
                if (historyIndex < 0 || historyIndex >= history.length) {
                    console.error("History index out of bounds during source update.");
                    return;
                }
                const currentImageUrl = history[historyIndex];

                // Temporarily disable the apply button to prevent race conditions.
                applyBtn.disabled = true;
                try {
                    // Fetch the image data from its URL (works for both data: and blob: URLs)
                    const response = await fetch(currentImageUrl);
                    const imageBlob = await response.blob();

                    // Create a new File object and set it as the current source for editing.
                    const fileType = imageBlob.type || 'image/png';

                    // Re-enable the apply button now that the source is updated.
                    const fileName = `history-image-${Date.now()}.png`;
                    originalFile = new File([imageBlob], fileName, { type: fileType });
                    applyBtn.disabled = false;
                } catch (error) {
                    console.error("Error updating source image from history:", error);
                    showToast("Error: Could not set the current image as the source for the next edit.");
                    // Keep the button disabled if it fails, as the app state is inconsistent.
                }
            };

            // **** END FIX ****

            const downloadImage = () => {
                if (!imagePreview.src || imagePreview.src.startsWith('data:')) {
                    showToast("There is no generated image to download yet.");
                    return;
                }
                const a = document.createElement('a');
                a.href = imagePreview.src;
                a.download = `stylized-image-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const showToast = (message, isSuccess = false) => {
                errorToast.textContent = message;
                errorToast.style.background = isSuccess ? '#28a745' : 'var(--tertiary-color)';
                errorToast.style.display = 'block';
                setTimeout(() => { errorToast.style.display = 'none'; }, 4000);
            };

            const showButtonFeedback = (button, message = "Saved!", duration = 2000) => {
                const originalText = button.innerHTML;
                button.innerHTML = message;
                button.disabled = true;
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, duration);
            };

            const updateHistoryButtons = () => {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= history.length - 1;
            };

            // **** START FIX ****
            // Replaced the original functions with async versions that update the source file.

            const undo = async () => {
                if (historyIndex > 0) {
                    // IMPORTANT: Update the source 'originalFile' to match the undone image,
                    // so the next 'Apply' action works on the currently displayed image.
                    historyIndex--;
                    imagePreview.src = history[historyIndex];
                    updateHistoryButtons();
                    await updateSourceImageFromHistory();
                }
            };

            const redo = async () => {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    imagePreview.src = history[historyIndex];
                    updateHistoryButtons();
                    // IMPORTANT: Update the source 'originalFile' to match the redone image.
                    await updateSourceImageFromHistory();
                }
            };
            // **** END FIX ****


            const setActiveProfileButton = (activeProfile) => {
                profileButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.profile === activeProfile));
            };

            const setupOptionalField = (checkbox, input) => {
                checkbox.addEventListener('change', () => { input.disabled = !checkbox.checked; });
            };

            const checkForExistingJob = () => {
                const existingJobId = localStorage.getItem('activeJobId');
                if (existingJobId) {
                    showToast("Checking status of a previous job...", true);
                    loader.style.display = 'flex';
                    applyBtn.disabled = true;
                    // You must have a file for polling to work. A placeholder will do.
                    originalFile = new File([""], "placeholder.txt");
                    pollForJobCompletion(existingJobId);
                }
            };

            // --- EVENT LISTENERS ---

            // NEW: Central handler for when the preview image's source is updated.
            imagePreview.addEventListener('load', () => {
                // This event fires whenever imagePreview.src is successfully changed and the new image is loaded.
                // This covers initial upload, undo, and redo.
                maybeAdjustResolution();
            });

            // File Upload
            // MODIFIED: Check if upload area is disabled before acting
            uploadArea.addEventListener('click', () => {
                if (!uploadArea.classList.contains('disabled')) {
                    fileInput.click();
                }
            });
            fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!uploadArea.classList.contains('disabled')) {
                    uploadArea.classList.add('drag-over');
                }
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (!uploadArea.classList.contains('disabled')) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            // NEW: Listener for the cancel button
            cancelUploadBtn.addEventListener('click', resetUploadUI);

            // Main Actions
            applyBtn.addEventListener('click', applyEdits);
            downloadBtn.addEventListener('click', downloadImage);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            // Settings Management
            saveDefaultsBtn.addEventListener('click', saveDefaults);
            resetDefaultsBtn.addEventListener('click', resetToAppDefaults);

            // Custom Profile Management
            saveProfileBtn.addEventListener('click', saveCustomProfile);
            customProfileSelect.addEventListener('change', loadCustomProfile);
            deleteProfileBtn.addEventListener('click', deleteCustomProfile);

            // Profile Buttons
            profileButtons.forEach(button => button.addEventListener('click', () => loadSettings(button.dataset.profile)));

            // NEW: Advanced Settings Toggle on the entire header
            advancedSettingsHeader.addEventListener('click', () => {
                const isExpanded = advancedSettingsHeader.getAttribute('aria-expanded') === 'true';
                advancedSettingsHeader.setAttribute('aria-expanded', String(!isExpanded));

                // Slider and Number Input Sync
                advancedSettingsContent.style.display = isExpanded ? 'none' : 'block';
            });
            const syncSliderAndNumber = (slider, number, valueLabel) => {
                slider.addEventListener('input', () => { number.value = slider.value; if (valueLabel) valueLabel.textContent = slider.value; });
                number.addEventListener('input', () => { slider.value = number.value; if (valueLabel) valueLabel.textContent = number.value; });
            };
            syncSliderAndNumber(stepsSlider, stepsNumber, stepsValue);
            syncSliderAndNumber(guidanceSlider, guidanceNumber, guidanceValue);
            syncSliderAndNumber(cfgSlider, cfgNumber, cfgValue);

            // NEW: Adjust resolution checkbox listener
            adjustResolutionCheckbox.addEventListener('change', () => {
                const isChecked = adjustResolutionCheckbox.checked;
                // If user checks the box, immediately try to adjust resolution
                if (isChecked) {
                    maybeAdjustResolution();
                }
                widthInput.disabled = isChecked;
                heightInput.disabled = isChecked;
            });


            // Optional Field Logic
            setupOptionalField(prompt2Enabled, prompt2Input);
            setupOptionalField(negativePromptEnabled, negativePromptInput);
            setupOptionalField(negativePrompt2Enabled, negativePrompt2Input);
            useSpecificSeedCheckbox.addEventListener('change', () => { seedInput.disabled = !useSpecificSeedCheckbox.checked; });

            // --- INITIALIZATION ---
            loadSettings('default'); // Load user defaults or app defaults on start
            populateCustomProfiles(); // Load custom profiles from local storage
            checkForExistingJob();

            // --- START: ACCORDION LOGIC FIX ---
            const accordionContainer = document.getElementById('style-profiles-accordion');
            if (accordionContainer) {
                const allCategories = accordionContainer.querySelectorAll('.profile-category');

                accordionContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.profile-category-header');
                    if (!header) return; // Exit if click was not on a header

                    const parentCategory = header.parentElement;
                    const isAlreadyActive = parentCategory.classList.contains('active');

                    // First, close all categories. The logic should ONLY toggle classes.
                    // The CSS will handle showing/hiding, preventing inline style conflicts.
                    allCategories.forEach(cat => {
                        cat.classList.remove('active');
                        cat.querySelector('.profile-category-header').setAttribute('aria-expanded', 'false');
                    });

                    // If the clicked category was not already active, open it.
                    // This creates the desired accordion behavior:
                    // - Clicking a closed item opens it.
                    // - Clicking an open item closes it (and all others remain closed).
                    if (!isAlreadyActive) {
                        parentCategory.classList.add('active');
                        header.setAttribute('aria-expanded', 'true');
                    }
                });

                // Use event delegation for keyboard accessibility as well
                accordionContainer.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        // We only care about keydown on the header itself for accessibility
                        const header = e.target.closest('.profile-category-header');
                        if (header) {
                            e.preventDefault(); // Prevent page from scrolling on Space
                            header.click();     // Trigger the click event handler we just defined
                        }
                    }
                });
            }
            // --- END: ACCORDION LOGIC FIX ---
        });
    </script>
</body>

</html>
